import csv
import re
import os


# permissions.csv contains list of extracted permissions to use as feature labels
with open('permissions.csv', 'r') as permissions_file:
    csv_reader = csv.reader(permissions_file)
    field_names = []

    field_names.append("MALWARE_TYPE")

    # appends to list of feature/class labels
    for row in csv_reader:
        field_names.append(row[0].removeprefix('android.permission.'))
    field_names.append("HAS_MALWARE")
    '''
    # write header as feature/class labels
    with open('dataset.csv', 'w') as csv_file:
       csv_writer = csv.DictWriter(csv_file, fieldnames = field_names, delimiter= ",")
       csv_writer.writeheader()
    '''
    
    # retrieves apk permissions from all malware samples
    rootdir = r'/Users/sem/Downloads/MalwareSamples'
    with open('even_larger_dataset.csv', 'w', newline ="") as testing:
        csv_writer = csv.writer(testing, delimiter= ",")
        csv_writer.writerow(field_names)
        #csv_writer.writeheader()
        for subdir, dirs, files in os.walk(rootdir):
            for file in files:
                filename = os.fsdecode(file)
                if filename.startswith('permissionsFromApk'):
                    #print(subdir)
                    #print(os.path.join(subdir, file))
                    with open(subdir+ "/" + filename, 'r') as from_apk_file:
                        csv_reader = csv.DictReader(from_apk_file)
                        subdir_name = os.fsdecode(subdir)
                        malware_type = str(subdir_name.split(r"/Users/sem/Downloads/MalwareSamples", 1)[-1])
                        malware_type = malware_type.split("/", 1)[-1].partition('/')[0]
                        #print(final_split)
                        list_of_permissions = []
                        labels = []
                        if csv_reader != []:
                            list_of_permissions.append(malware_type)  
                            labels.append(malware_type)

                            # For getting permissions from each apk file                     
                            for line in csv_reader:
                                #print(line)
                                # only grabbing permissions that contain android.permission
                                if 'android.permission' in str(line):
                                    permission_str = (str(line).split('android.permission.', 1)[-1])[:-3]
                                    #print(permission_str)
                                    list_of_permissions.append(permission_str)

                            # For filling in dataset with 0 or 1 
                            for i in range(1, len(field_names)):
                                if field_names[i] in list_of_permissions:
                                    labels.append(1)
                                elif field_names[i]=="HAS_MALWARE" and malware_type!="Benign":
                                    labels.append(1)
                                else:
                                    labels.append(0)
                
                            csv_writer.writerow(labels)


